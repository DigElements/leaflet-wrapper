<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../leaflet-map/leaflet-map.html">

<!--
A polymer web component that wraps a leaflet-map.

Example:

        <leaflet-wrapper
          data="[[array]]">
        </leaflet-wrapper>

@demo demo/index.html
-->

<dom-module id="leaflet-wrapper">
  <template>
    <style>
      :host {
        display: block;
      }

      leaflet-map {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      leaflet-map ::content .leaflet-container .leaflet-control-attribution {
        opacity: 0.5;
        transition: opacity 0.28s cubic-bezier(0.4, 0, 0.2, 1);
      }

      leaflet-map ::content .leaflet-container .leaflet-control-attribution:hover {
        opacity: 1;
      }

      leaflet-map ::content .leaflet-bar {
        box-shadow:
          1px 2px 3px 0 rgba(0, 0, 0, 0.14),
          1px 1px 6px 0 rgba(0, 0, 0, 0.12),
          1px 3px 2px -2px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      leaflet-map ::content .leaflet-bar a,
      leaflet-map ::content .leaflet-bar a:hover {
        color: var(--secondary-text-color);
      }

      leaflet-map ::content .leaflet-bar a:first-child {
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
      }

      leaflet-map ::content .leaflet-bar a:last-child {
        border-bottom-left-radius: 2px;
        border-bottom-right-radius: 2px;
      }

      paper-menu-button {
        padding: 0;
        position: absolute;
        right: 0;
        margin-top: 10px;
        margin-right: 10px;
      }

      paper-icon-button {
        --paper-icon-button: {
          padding: 6px;
          height: 30px;
          width: 30px;
        };
        background: white;
        border: 1px solid rgb(204, 204, 204);
        border-radius: 2px;
      }

      paper-icon-button::shadow #icon {
        height: 16px;
        width: 16px;
      }

      paper-menu {
        padding: 0;
      }

      paper-item:hover {
        background-color: rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      paper-radio-button {
        --paper-radio-button-size: 10px;
        display: block;
      }
    </style>

    <!-- Need the if/else case since fit-to-markers attribute won't work properly with only one marker/location -->
    <template is="dom-if" if="{{hasMultipleLocations}}">
      <leaflet-map fit-to-markers>
        <template is="dom-repeat" items="{{data}}" as="location">
          <leaflet-marker latitude="[[getProperty(location, latitudeProperty)]]" longitude="[[getProperty(location, longitudeProperty)]]" title$="[[getProperty(location, textProperty, '')]]">
            [[getProperty(location, textProperty)]]
          </leaflet-marker>
        </template>
      </leaflet-map>
    </template>

    <template is="dom-if" if="{{hasSingleLocation}}">
      <leaflet-map latitude="[[getSingleLocationProperty(latitudeProperty)]]" longitude="[[getSingleLocationProperty(longitudeProperty)]]" zoom="10">
        <!-- Combine the attribution for all tile layers because changing the attribution property dynamically does not update the text. -->
        <leaflet-tilelayer
          url="[[tileUrl]]"
          attribution='CartoDB Positron &copy; <a href="http://cartodb.com/attributions">CartoDB</a>, Hydda tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a>, OpenMapSurfer imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a>, OpenStreetMap data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          nowrap>
        </leaflet-tilelayer>

        <leaflet-marker latitude="[[getSingleLocationProperty(latitudeProperty)]]" longitude="[[getSingleLocationProperty(longitudeProperty)]]" title$="[[getSingleLocationProperty(textProperty, '')]]">
          [[getSingleLocationProperty(textProperty)]]
        </leaflet-marker>
      </leaflet-map>
    </template>

    <paper-menu-button horizontal-align="right">
      <paper-icon-button icon="maps:layers" class="dropdown-trigger"></paper-icon-button>
      <paper-menu class="dropdown-content">
        <paper-radio-group selected="{{tileType}}">
          <paper-radio-button name="Positron">CartoDB Positron</paper-radio-button>
          <paper-radio-button name="Hydda">Hydda</paper-radio-button>
          <paper-radio-button name="OpenMapSurfer">OpenMapSurfer</paper-radio-button>
          <paper-radio-button name="OpenStreetMap">OpenStreetMap</paper-radio-button>
        </paper-radio-group>
      </paper-menu>
    </paper-menu-button>
  </template>


  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals L */
      is: 'leaflet-wrapper',

      properties: {
        /**
         * The latitude property in the map data.
         */
        latitudeProperty: {
          type: String,
          value: 'latitude'
        },

        /**
         * The longitude property in the map data.
         */
        longitudeProperty: {
          type: String,
          value: 'longitude'
        },

        /**
         * The text property in the map data.
         */
        textProperty: {
          type: String,
          value: 'text'
        },

        /**
         * The data for the map.
         */
        data: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true,
          observer: 'onDataChange'
        },

        /**
         * Whether the map has multiple locations.
         */
        hasMultipleLocations: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        /**
         * Whether the map has a single location.
         */
        hasSingleLocation: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        tileType: {
          type: String,
          value: 'OpenMapSurfer',
          observer: '_onTileChange'
        },

        tileUrl: {
          type: String,
          notify: true,
          value: 'http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}'
        }
      },

      ready: function() {
        // open issue for leaflet-map: https://github.com/leaflet-extras/leaflet-map/issues/15
        // if imagePath for leaflet-map icons cannot be detected, manually set it here:
        if(!L.Icon.Default.imagePath) {
          L.Icon.Default.imagePath = 'bower_components/leaflet/dist/images';
        }
      },

      /**
       * Sets whether the data has a single or multiple locations whenever the data changes.
       */
      onDataChange: function() {
        this._setHasMultipleLocations(this.data && this.data.length > 1);
        this._setHasSingleLocation(this.data && this.data.length === 1);
      },

      _onTileChange: function() {
        if(this.tileType === 'Hydda') {
          this.tileUrl = 'http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png';
        }
        if(this.tileType === 'OpenMapSurfer') {
          this.tileUrl = 'http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}';
        }
        if(this.tileType === 'OpenStreetMap') {
          this.tileUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        }
        if(this.tileType === 'Positron') {
          this.tileUrl = 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
        }
      },

      /**
       * Returns the given property in the given item.
       */
      getProperty: function(item, property, defaultValue) {
        return item[property] || defaultValue;
      },

      /**
       * Returns the given property in the single item in the data.
       */
      getSingleLocationProperty: function(property, defaultValue) {
        return this.getProperty(this.data[0], property, defaultValue);
      }
    });
  })();
  </script>
</dom-module>
